---
title: "Cost coloring of bipartite graphs"
output:
  pdf_document:
    toc: yes
  html_notebook:
    theme: united
    toc: yes
  html_document:
    toc: yes
---

# Init
```{r cho = T, results = 'hide'}
library(igraph)
library(parallel)
library(tictoc)

source("src/3-pseudocoloring.R")
source("src/2-coloring.R")
source("src/is_colored_properly.R")
source("src/sum_coloring.R")
source("src/27_26-approximate-coloring.R")
source("src/brute_force.R")
source("src/is_optimal.R")
```
# Reference input
```{r}
c <- c(1,2,3,4)
# g <- read.graph("graphs/bipartite.graphml", "graphml")
g <- read.graph("case1/1.graphml", "graphml")

# setEPS()
# postscript("graphs/reference_graph.eps", fonts = c("serif"))
plot(g, layout=layout_as_bipartite, main='input graph', vertex.size=40, vertex.label.cex=1, vertex.label = paste(V(g)$name, '/', V(g)$weight))
# dev.off()
```
# Test 27/26-algorithm
```{r}
# c <- c(1,2,3,4)
# g <- read.graph("case1/1.graphml", "graphml")

tic("27/26-approximate algorithm")
result <- four_coloring(g, c)
toc()

S <- result[[1]]
Ssum <- result[[2]]

result_print(S, Ssum)
```
# Brute force test
```{r}
# c <- c(1,2,3,4)
# g <- read.graph("test1/1/3.graphml", "graphml")

tic('Brute force')
B <- brute_force(g, c, Ssum)
toc()

result_print(B[[1]], B[[2]])
```
# Test 1
```{r}
tic('test 1')
n <- 8
density <- c(0.4, 0.5, 0.6, 0.7, 0.8, 0.9)
density <- c(0.4)
for (i in 1:length(density)) {
  path <- paste0('test1/', i)
  if (!dir.exists(path))
    dir.create(path)
  
  for(j in 1:10) {
    graph <- sample_bipartite(n/2, n/2, p=density[i])
    V(graph)$weight <- sample(c(1,2,6,24), n, replace = TRUE)
    V(graph)$name <- letters[1:n]
    
    approximated <- four_coloring(graph, c)
    bruteForced <- brute_force(graph, c, approximated[[2]])

    V(graph)$color = V(approximated[[1]])$color
    V(graph)$color2 = V(bruteForced[[1]])$color
    graph$approximated = approximated[[2]]
    graph$optimal = sum_coloring(bruteForced[[1]], c)
    
    print(graph$approximated)
    print(graph$optimal)
    
    write_graph(graph, paste0('test1/', i ,'/', j, '.graphml'), "graphml")
  }
}
toc()
```
# Test 0
```{r}
c <- c(1,2,3,4)
n = 11
g <- sample_bipartite(floor(n/2), ceiling(n/2), p=0.4)
V(g)$weight = sample(c(1,2,6,24), n, replace = TRUE)
V(g)$name <- letters[1:n]

# g <- read.graph("graphs/bipartite.graphml", "graphml")

tic("27/26-approximate")
result <- four_coloring(g, c)
toc()

S <- result[[1]]
Ssum <- result[[2]]
result_print(S, Ssum)

g$sumS <- Ssum

tic("brute_force")
B <- brute_force2(g, c, Ssum)
Bsum <- sum_coloring(B, c)
toc()

result_print(B, Bsum)

g$sumB <- Bsum
g$optimal <- Bsum == Ssum
write_graph(g, "graphs/test1/9_04.graphml", "graphml")

```
# graph generator
```{r}
n = 9
g <- sample_bipartite(floor(n/2), ceiling(n/2), p=0.8)
V(g)$weight = sample(c(1,2,6,24), n, replace = TRUE)
V(g)$name <- letters[1:n]
```

# Test 1 - different weight combinations
```{r}
tic('Generating graphs for test1')
weights <- c(1,2,6,24)
for (i in 1:length(weights)**length(V(g))) {
# for (i in 1:2) {
  gtmp <- g
  
  for (j in 1:length(V(gtmp))) {
    V(gtmp)[j]$weight <- 1
  }
  
  write_graph(gtmp, paste0('graphs/test1/', i, '.graphml'), "graphml")
}
toc()
```
# Write graph
```{r}
write_graph(g, "graphs/points_7_8_case.graphml", "graphml")
```
# Generate graphs to tests
```{r}
density <- c(0.2, 0.4, 0.6, 0.8, 1)
n <- 8

graphs <- lapply(density, function(x) {
  g <- sample_bipartite(floor(n/2), ceiling(n/2), p = x)
  V(g)$weight <- sample(1:10, n, replace = T)
  
  return (g)
})
graphs[[i]]

for (i in 1:length(graphs)) {
  # tic('Brute Force')
  # B <- brute_force(graphs[[i]], c)
  # Bsum <- color_sum(B, c)
  # toc()
  
  # tic('27/26 - approximate')
  # A <- four_coloring(graphs[[i]], c)
  # Asum <- color_sum(A, c)
  # toc()

  # print(paste('Approximation: ', Bsum / Asum))
}

```
# Number of combinations
```{r}
for (n in 1:20) {
  g3 <- make_full_bipartite_graph(floor(n/2), ceiling(n/2))
  
  proper <- 0
    
  for(j in k**n) {
    coloring <- sapply(as.list(rep(j, n)), function(x){
      i <- parent.frame()$i[]
      index <- 1 + (x / k ** (i-1)) %% k
      return(c[index])
    })
    
    V(g3)$color <- coloring
    
    if(colored_properly(graph)) {
      proper <- proper + 1
    }
    
  }
  
  print(n)
  print(k**n)
  print('next')
}
```
